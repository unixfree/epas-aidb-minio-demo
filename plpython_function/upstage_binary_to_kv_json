CREATE OR REPLACE FUNCTION upstage_binary_to_kv_json(my_bin_image BINARY, my_name string, my_mime string)
RETURNS JSONB AS $$

import requests
import json
import os

def call_upstage_ocr(bin_image: bytes, name: str, mime: str, api_key: str) -> dict:
    """
    Upstage AI의 Document OCR API를 호출하여 결과를 반환하는 함수입니다.

    Args:
        bin_image: OCR을 수행할 이미지 파일의 경로입니다.
        mime : mime.
        api_key: Upstage AI API 키입니다.

    Returns:
        API 호출 결과를 담은 딕셔너리(dict)입니다. 오류 발생 시 오류 정보를 담은 딕셔너리를 반환합니다.
    """
    url = "https://api.upstage.ai/v1/document-digitization"
    headers = {"Authorization": f"Bearer {api_key}"}
    data = {"model": "ocr"}

    files_to_upload = {
      'document': (name, bin_image, mime)
    }

    response = requests.post(url, headers=headers, files=files_to_upload, data=data)
    # 성공 시 JSON 응답을 파싱하여 반환합니다.
    return response.json()

# --- 이 스크립트를 직접 실행할 때만 아래 코드가 동작합니다 ---
if __name__ == "__main__":
    # 실제 API 키와 파일 경로를 여기에 입력하세요.
    my_api_key = "YOUR_UPSTAGE_API_KEY"    # https://console.upstage.ai/docs/getting-started
    #my_file_path = '/Users/paul.son/Workplace/edb/ElectronicTaxInvoice.png'

    result = call_upstage_ocr(bin_image=my_bin_image, name=my_name, mime=my_mime, api_key=my_api_key)
    #python_dict_result = {'field1': 'data1', 'field2': 'data2'}
    return json.dumps(result)

$$ LANGUAGE plpython3u;
